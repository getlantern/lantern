name: Nightly

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      platforms:
        description: "Space-separated list of platforms to build"
        required: false
        default: "linux"
      dry_run:
        description: "Echo steps instead of building (quick test)"
        required: false
        type: boolean
        default: false

concurrency:
  group: nightly

env:
  BUILD_TYPE: nightly
  FLUTTER_VERSION: "3.24.x"
  GO_VERSION: "1.25.x"

jobs:
  set-nightly-metadata:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      installer_name: ${{ steps.meta.outputs.installer_name }}
      run_linux: ${{ steps.platforms.outputs.run_linux }}
      run_macos: ${{ steps.platforms.outputs.run_macos }}
      run_windows: ${{ steps.platforms.outputs.run_windows }}
      run_android: ${{ steps.platforms.outputs.run_android }}
      run_ios: ${{ steps.platforms.outputs.run_ios }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - id: meta
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG_LATEST=$(git describe --tags --abbrev=0)
          echo "version tag (latest): $TAG_LATEST"

          RELEASE_BASE=$(echo "$TAG_LATEST" | awk -F'-' '{print $1}')
          echo "version base (current): $RELEASE_BASE"

          # increment the patch of the latest tag by 1
          RELEASE_BASE_NEXT=$(echo "$RELEASE_BASE" | awk -F'\\.' -v OFS='.' '{ $NF = $NF + 1; print }')
          echo "version base (next): $RELEASE_BASE_NEXT"

          DATE=$(date -u +%Y%m%dT%H%M%SZ) # ISO 8601 without colons or dashes
          REF=$(git rev-parse --short HEAD)
          VER="${RELEASE_BASE_NEXT}-${REF}-${DATE}"
          echo "version (next): $VER"
          echo "version=$VER" >> "$GITHUB_OUTPUT"
          echo "installer_name=lantern-installer-nightly" >> "$GITHUB_OUTPUT"

      - id: platforms
        shell: bash
        env:
          RAW_INPUT: ${{ github.event_name == 'schedule' && 'all' || github.event.inputs.platforms }}
        run: |
          RAW="${RAW_INPUT:-all}"
          # normalize input
          PLAT="$(echo "$RAW" \
            | tr '[:upper:]' '[:lower:]' \
            | tr ',;/' ' ' \
            | xargs)"
          echo "Building platforms: '$PLAT'"

          want() {
            local p="$1"
            if [[ "$PLAT" == "all" ]]; then
              echo true
            elif [[ " $PLAT " == *" $p "* ]]; then
              echo true
            else
              echo false
            fi
          }

          echo "run_linux=$(want linux)"     >> "$GITHUB_OUTPUT"
          echo "run_macos=$(want macos)"     >> "$GITHUB_OUTPUT"
          echo "run_windows=$(want windows)" >> "$GITHUB_OUTPUT"
          echo "run_android=$(want android)" >> "$GITHUB_OUTPUT"
          echo "run_ios=$(want ios)"         >> "$GITHUB_OUTPUT"

      - name: Update pubspec.yaml (build number only)
        shell: bash
        run: |
          # Extract everything before '+' (keeps pre-release if present)
          BASE=$(sed -nE 's/^version:[[:space:]]*([^+]+).*/\1/p' pubspec.yaml)
          NEW_VERSION="${BASE}+${GITHUB_RUN_NUMBER}"
          echo "Setting version: ${NEW_VERSION}"
          sed -i.bak -E "s/^version:.*/version: ${NEW_VERSION}/" pubspec.yaml
          grep '^version:' pubspec.yaml

      - name: Upload pubspec.yaml
        uses: actions/upload-artifact@v4
        with:
          name: pubspec
          path: pubspec.yaml

  build-macos:
    needs: set-nightly-metadata
    if: ${{ needs.set-nightly-metadata.outputs.run_macos == 'true' }}
    uses: ./.github/workflows/build-macos.yml
    secrets: inherit
    with:
      version: ${{ needs.set-nightly-metadata.outputs.version }}
      build_type: nightly
      installer_name: ${{ needs.set-nightly-metadata.outputs.installer_name }}

  build-windows:
    needs: set-nightly-metadata
    if: ${{ needs.set-nightly-metadata.outputs.run_windows == 'true' }}
    uses: ./.github/workflows/build-windows.yml
    secrets: inherit
    with:
      version: ${{ needs.set-nightly-metadata.outputs.version }}
      build_type: nightly
      installer_name: ${{ needs.set-nightly-metadata.outputs.installer_name }}

  build-linux:
    needs: set-nightly-metadata
    if: ${{ needs.set-nightly-metadata.outputs.run_linux == 'true' }}
    uses: ./.github/workflows/build-linux.yml
    secrets: inherit
    with:
      version: ${{ needs.set-nightly-metadata.outputs.version }}
      build_type: nightly
      installer_name: ${{ needs.set-nightly-metadata.outputs.installer_name }}

  build-android:
    needs: set-nightly-metadata
    if: ${{ needs.set-nightly-metadata.outputs.run_android == 'true' }}
    uses: ./.github/workflows/build-android.yml
    secrets: inherit
    with:
      version: ${{ needs.set-nightly-metadata.outputs.version }}
      build_type: nightly
      installer_name: ${{ needs.set-nightly-metadata.outputs.installer_name }}

  build-ios:
    needs: set-nightly-metadata
    if: ${{ needs.set-nightly-metadata.outputs.run_ios == 'true' }}
    uses: ./.github/workflows/build-ios.yml
    secrets: inherit
    with:
      version: ${{ needs.set-nightly-metadata.outputs.version }}
      build_type: nightly
      installer_name: ${{ needs.set-nightly-metadata.outputs.installer_name }}

  publish:
    needs:
      [
        set-nightly-metadata,
        build-macos,
        build-windows,
        build-linux,
        build-android,
        build-ios,
      ]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    env:
      INSTALLER_NAME: ${{ needs.set-nightly-metadata.outputs.installer_name }}
      BUCKET: ${{ vars.S3_RELEASES_BUCKET }}
      RUN_MACOS: ${{ needs.set-nightly-metadata.outputs.run_macos }}
      RUN_WINDOWS: ${{ needs.set-nightly-metadata.outputs.run_windows }}
      RUN_ANDROID: ${{ needs.set-nightly-metadata.outputs.run_android }}
      RUN_LINUX: ${{ needs.set-nightly-metadata.outputs.run_linux }}
      RUN_IOS: ${{ needs.set-nightly-metadata.outputs.run_ios }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4

      - name: Create GitHub Pre-Release
        if: github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.set-nightly-metadata.outputs.version }}
        run: |
          sha="$(git rev-parse --short HEAD)"

          cat > release_notes.md <<EOF

          This is an automated nightly build from commit \`$sha\`.

          **Branch:** \`${{ github.ref_name }}\`

          EOF

          # Create the pre-release as a draft, because immutable releases 
          # forbid uploading artifacts after publication.
          gh release create "$VERSION" \
            --draft \
            --prerelease \
            --title "Nightly $VERSION" \
            --notes-file release_notes.md

      - name: Upload artifacts to GitHub Release
        if: github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.set-nightly-metadata.outputs.version }}
        run: |
          if [[ "$RUN_MACOS" == "true" ]] && [[ -f "lantern-installer-dmg/${INSTALLER_NAME}.dmg" ]]; then
            gh release upload "$VERSION" "lantern-installer-dmg/${INSTALLER_NAME}.dmg"
          fi

          if [[ "$RUN_WINDOWS" == "true" ]] && [[ -f "lantern-installer-exe/${INSTALLER_NAME}.exe" ]]; then
            gh release upload "$VERSION" "lantern-installer-exe/${INSTALLER_NAME}.exe"
          fi

          if [[ "$RUN_ANDROID" == "true" ]] && [[ -f "lantern-installer-apk/${INSTALLER_NAME}.apk" ]]; then
            gh release upload "$VERSION" "lantern-installer-apk/${INSTALLER_NAME}.apk"
          fi

          if [[ "$RUN_LINUX" == "true" ]]; then
            if [[ -f "lantern-installer-deb/${INSTALLER_NAME}.deb" ]]; then
              gh release upload "$VERSION" "lantern-installer-deb/${INSTALLER_NAME}.deb"
            fi
            if [[ -f "lantern-installer-rpm/${INSTALLER_NAME}.rpm" ]]; then
              gh release upload "$VERSION" "lantern-installer-rpm/${INSTALLER_NAME}.rpm"
            fi
          fi

      - name: Publish GitHub Pre-Release
        if: success() && github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.set-nightly-metadata.outputs.version }}
        run: |
          # Publish the draft release (only if artifact upload succeeded)
          gh release edit "$VERSION" --draft=false

      # Don't keep releases where artifact creation or upload has failed.
      - name: Cleanup Failed GitHub Pre-Release
        if: |
          (failure() ||
           needs.build-macos.result == 'failure' ||
           needs.build-windows.result == 'failure' ||
           needs.build-linux.result == 'failure' ||
           needs.build-android.result == 'failure' ||
           needs.build-ios.result == 'failure') &&
          github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.set-nightly-metadata.outputs.version }}
        run: |
          gh release delete "$VERSION" --cleanup-tag

      - name: Upload to S3 (nightly + latest)
        if: github.event.inputs.dry_run != 'true'
        run: |
          sha="$(git rev-parse --short HEAD)"

          if [[ "$RUN_MACOS" == "true" ]]; then
            aws s3 cp "lantern-installer-dmg/${INSTALLER_NAME}.dmg" \
              "s3://${BUCKET}/nightly/${sha}/${INSTALLER_NAME}.dmg" --acl public-read
            aws s3 cp "lantern-installer-dmg/${INSTALLER_NAME}.dmg" \
              "s3://${BUCKET}/nightly/latest/${INSTALLER_NAME}.dmg" --acl public-read
          fi

          if [[ "$RUN_WINDOWS" == "true" ]]; then
            aws s3 cp "lantern-installer-exe/${INSTALLER_NAME}.exe" \
              "s3://${BUCKET}/nightly/${sha}/${INSTALLER_NAME}.exe" --acl public-read
            aws s3 cp "lantern-installer-exe/${INSTALLER_NAME}.exe" \
              "s3://${BUCKET}/nightly/latest/${INSTALLER_NAME}.exe" --acl public-read
          fi

          if [[ "$RUN_ANDROID" == "true" ]]; then
            aws s3 cp "lantern-installer-apk/${INSTALLER_NAME}.apk" \
              "s3://${BUCKET}/nightly/${sha}/${INSTALLER_NAME}.apk" --acl public-read
            aws s3 cp "lantern-installer-apk/${INSTALLER_NAME}.apk" \
              "s3://${BUCKET}/nightly/latest/${INSTALLER_NAME}.apk" --acl public-read
          fi

          if [[ "$RUN_LINUX" == "true" ]]; then
            if [[ -f "lantern-installer-deb/${INSTALLER_NAME}.deb" ]]; then
              aws s3 cp "lantern-installer-deb/${INSTALLER_NAME}.deb" \
                "s3://${BUCKET}/nightly/${sha}/${INSTALLER_NAME}.deb" --acl public-read
              aws s3 cp "lantern-installer-deb/${INSTALLER_NAME}.deb" \
                "s3://${BUCKET}/nightly/latest/${INSTALLER_NAME}.deb" --acl public-read
            fi

            if [[ -f "lantern-installer-rpm/${INSTALLER_NAME}.rpm" ]]; then
              aws s3 cp "lantern-installer-rpm/${INSTALLER_NAME}.rpm" \
                "s3://${BUCKET}/nightly/${sha}/${INSTALLER_NAME}.rpm" --acl public-read
              aws s3 cp "lantern-installer-rpm/${INSTALLER_NAME}.rpm" \
                "s3://${BUCKET}/nightly/latest/${INSTALLER_NAME}.rpm" --acl public-read
            fi
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Links
        if: github.event.inputs.dry_run != 'true'
        run: |
          sha="$(git rev-parse --short HEAD)"
          {
            echo "## Nightly links (commit \`$sha\`)"
            if [[ "$RUN_MACOS" == "true" ]]; then
              echo "- macOS:     https://$BUCKET.s3.amazonaws.com/nightly/${sha}/${INSTALLER_NAME}.dmg"
            fi
            if [[ "$RUN_WINDOWS" == "true" ]]; then
              echo "- Windows:   https://$BUCKET.s3.amazonaws.com/nightly/${sha}/${INSTALLER_NAME}.exe"
            fi
            if [[ "$RUN_ANDROID" == "true" ]]; then
              echo "- Android:   https://$BUCKET.s3.amazonaws.com/nightly/${sha}/${INSTALLER_NAME}.apk"
            fi
            if [[ "$RUN_LINUX" == "true" ]]; then
              echo "- Linux DEB: https://$BUCKET.s3.amazonaws.com/nightly/${sha}/${INSTALLER_NAME}.deb"
              echo "- Linux RPM: https://$BUCKET.s3.amazonaws.com/nightly/${sha}/${INSTALLER_NAME}.rpm"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Build Slack message
        if: github.event.inputs.dry_run != 'true'
        id: slack_msg
        run: |
          sha="$(git rev-parse --short HEAD)"
          version="${{ needs.set-nightly-metadata.outputs.version }}"
          text="Lantern nightly <https://github.com/getlantern/lantern/releases/tag/$version|$version> is ready.\n*Branch:* '${{ github.ref_name }}'\n*Downloads:*"

          if [[ "$RUN_MACOS" == "true" ]]; then
            text="${text}\n• <https://${BUCKET}.s3.amazonaws.com/nightly/${sha}/${INSTALLER_NAME}.dmg|macOS>"
          fi
          if [[ "$RUN_WINDOWS" == "true" ]]; then
            text="${text}\n• <https://${BUCKET}.s3.amazonaws.com/nightly/${sha}/${INSTALLER_NAME}.exe|Windows>"
          fi
          if [[ "$RUN_ANDROID" == "true" ]]; then
            text="${text}\n• <https://${BUCKET}.s3.amazonaws.com/nightly/${sha}/${INSTALLER_NAME}.apk|Android>"
          fi
          if [[ "$RUN_LINUX" == "true" ]]; then
            text="${text}\n• <https://${BUCKET}.s3.amazonaws.com/nightly/${sha}/${INSTALLER_NAME}.deb|Linux (.deb)>"
            text="${text}\n• <https://${BUCKET}.s3.amazonaws.com/nightly/${sha}/${INSTALLER_NAME}.rpm|Linux (.rpm)>"
          fi

          # Expose as output
          echo "text<<EOF" >> "$GITHUB_OUTPUT"
          echo "$text"   >> "$GITHUB_OUTPUT"
          echo "EOF"     >> "$GITHUB_OUTPUT"

      - name: Notify Slack
        if: github.event.inputs.dry_run != 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: webhook-trigger
          payload: |
            {
              "text": "${{ steps.slack_msg.outputs.text }}"
            }
